<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="medicine_jb" >
  <resultMap id="CineJbResult" class="cn.krt.zbcg.commons.bo.system.MedicineJbBO" >
    <!--
      WARNING - This element is automatically generated by GBOSS-Abator for SSI, do not modify.
      This element was generated on Thu Sep 29 10:48:02 CST 2011.
    -->
    <result column="jb_id" property="jbId" jdbcType="INTEGER" />
    <result column="cg_id" property="cgId" jdbcType="INTEGER" />
    <result column="customer_account" property="customerAccount" jdbcType="VARCHAR" />
    <result column="medicine_code" property="medicineCode" jdbcType="VARCHAR" />
    <result column="ylcd" property="ylcd" jdbcType="VARCHAR" />
    <result column="price" property="price" jdbcType="DOUBLE" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="jb_state" property="jbState" jdbcType="CHAR" />
   	<result column="begin_date" property="beginDate" jdbcType="VARCHAR" />
    <result column="end_date" property="endDate" jdbcType="VARCHAR" />
    <result column="hg_state" property="hgState" jdbcType="VARCHAR" />
    <result column="view" property="view" jdbcType="VARCHAR" />
    <result property="medicineCgBO" column="cg_id" select="medicine_cg.selectById"/>
    <result property="customerBO" column="customer_account" select="customer.selectByCode"/>
  </resultMap>
  
  <select id="selectByPrimaryKey" resultMap="CineJbResult" parameterClass="cn.krt.zbcg.commons.bo.system.MedicineJbBO" >
    select jb_id, cg_id, customer_account, medicine_code, ylcd, price, remark, jb_state, begin_date,end_date,hg_state,view
    from medicine_jb
    where jb_id = #jbId#
  </select>
  
  <select id="selectById" resultMap="CineJbResult" parameterClass="int" >
    select jb_id, cg_id, customer_account, medicine_code, ylcd, price, remark, jb_state, begin_date,end_date,hg_state,view
    from medicine_jb
    where jb_id = #jbId#
  </select>
  
  <!-- 首先进行排名、排名那些不等于2的数据！！   第4次采购系统修改前-->
  <select id="getTops" resultMap="CineJbResult" parameterClass="java.util.Map" >    
    select jb_id, jb.cg_id, jb.customer_account, medicine_code, ylcd, price, jb.remark, jb_state, jb.begin_date,jb.end_date,hg_state,view
    from medicine_jb jb,medicine_cg cg
    where jb.cg_id = cg.cg_id  and medicine_id=#medicineId# 
    <isNotNull property="beginDate">
			<isNotEmpty  property="beginDate">
		 <![CDATA[	and jb.begin_date = '$beginDate$' ]]> 
			</isNotEmpty>
		</isNotNull>	
		and price>0 and jb_state!='2'
    order by price asc,jb.jb_id asc 
  </select>
  
  <!-- 首先进行排名、 第4次采购系统修改  WangYunLong 2012-4-23 -->
  <select id="resetGetTops" resultMap="CineJbResult" parameterClass="java.util.Map" >    
    select jb_id, jb.cg_id, jb.customer_account, medicine_code, ylcd, price, jb.remark, jb_state, jb.begin_date,jb.end_date,hg_state,view
    from medicine_jb jb,medicine_cg cg
    where jb.cg_id = cg.cg_id and medicine_id=#medicineId# 
    	and <![CDATA[substring(current_date(),1,10) = jb.end_date ]]> 
		and price>0 and jb_state!='2'
    order by price asc,jb.jb_id asc 
  </select>
  
   <!-- 查询排名的后的数据,第4次修改-->
  <select id="isTops" resultMap="CineJbResult" parameterClass="java.util.Map" >
    select jb_id, jb.cg_id, jb.customer_account, medicine_code, ylcd, price, jb.remark, jb_state, jb.begin_date,jb.end_date,hg_state,view
    from medicine_jb jb ,medicine_cg cg
    where jb.cg_id = cg.cg_id 
    <isNotNull property="medicineId">
			<isNotEmpty  property="medicineId">
		 <![CDATA[	and medicine_id = '$medicineId$' ]]> 
			</isNotEmpty>
		</isNotNull>
    <isNotNull property="beginDate">
			<isNotEmpty  property="beginDate">
		 <![CDATA[	and jb.begin_date >= '$beginDate$' ]]> 
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="endDate">
			<isNotEmpty  property="endDate">
		 <![CDATA[	and jb.end_date <= '$endDate$' ]]> 
			</isNotEmpty>
		</isNotNull>
		and jb_state='2' and price>0 order by price asc,jb_id asc
  </select>
  
  <update id="updateTopsDown"  parameterClass="java.util.Map" >
    update medicine_jb set jb_state=1 where cg_id in (select cg_id from medicine_cg where substring(cg_date,1,7)=substring(#cgDate#,1,7) and medicine_id in (select medicine_id from medicine where medicine_id=#medicineId#))
  </update>
   <!-- 排名后更新状态-->
  <update id="updateTopsUp"  parameterClass="java.util.Map" >
    update medicine_jb set jb_state=2 where jb_id=#jbId#
  </update>
   <!-- 第3次修改增加的样品编号-->
  <update id="updateMedicineCode"  parameterClass="java.util.Map" >
    update medicine_jb set medicine_code=#medicineCode# where jb_id=#jbId#
  </update>
  
  <select id="selectAll" resultMap="CineJbResult" parameterClass="java.util.Map" >
    <!--
      WARNING - This element is automatically generated by GBOSS-Abator for SSI, do not modify.
      This element was generated on Thu Sep 29 10:48:02 CST 2011.
    -->
     SELECT * FROM ( SELECT c.* from ( 
     select jb_id, jb.cg_id, customer_account, medicine_code, ylcd, price, jb.remark, jb_state, jb.begin_date,jb.end_date,hg_state,view
    from medicine_jb jb,medicine_cg cg
    where jb.cg_id = cg.cg_id and <![CDATA[substring(current_date(),1,10) >= jb.begin_date ]]> 
    	<isNotNull property="customerAccount">
			<isNotEmpty  property="customerAccount">
			and customer_account=#customerAccount#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="medicineId">
			<isNotEmpty  property="medicineId">
			and cg.medicine_id = #medicineId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="beginDate">
			<isNotEmpty  property="beginDate">
		 <![CDATA[	and jb.begin_date >= '$beginDate$' ]]> 
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="endDate">
			<isNotEmpty  property="endDate">
			<![CDATA[ and jb.end_date <= '$endDate$' ]]> 
			</isNotEmpty>
		</isNotNull>
     ) c) a order by cg_id desc
      LIMIT  $ibegin$, 10
  </select>
  <select id="selectAllOfCount" resultClass="java.lang.String" parameterClass="java.util.Map" >
    SELECT count(0) FROM ( SELECT c.* from ( 
     select jb_id, cg.cg_id, customer_account, medicine_code, ylcd, price, jb.remark, jb_state, jb.begin_date,jb.end_date,hg_state,view
    from medicine_jb jb,medicine_cg cg
    where jb.cg_id = cg.cg_id and <![CDATA[substring(current_date(),1,10) >= jb.begin_date ]]> 
    	<isNotNull property="customerAccount">
			<isNotEmpty  property="customerAccount">
			and customer_account=#customerAccount#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="medicineId">
			<isNotEmpty  property="medicineId">
			and cg.medicine_id = #medicineId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="beginDate">
			<isNotEmpty  property="beginDate">
		 <![CDATA[	and jb.begin_date >= '$beginDate$' ]]> 
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="endDate">
			<isNotEmpty  property="endDate">
			<![CDATA[  and jb.end_date <= '$endDate$' ]]> 
			</isNotEmpty>
		</isNotNull>
     ) c) a
  </select>
  <delete id="deleteByPrimaryKey" parameterClass="cn.krt.zbcg.commons.bo.system.MedicineJbBO" >
    <!--
      WARNING - This element is automatically generated by GBOSS-Abator for SSI, do not modify.
      This element was generated on Thu Sep 29 10:48:02 CST 2011.
    -->
    delete from medicine_jb
    where jb_id = #jbId#
  </delete>
  <insert id="insert" parameterClass="cn.krt.zbcg.commons.bo.system.MedicineJbBO" >
    <!--
      WARNING - This element is automatically generated by GBOSS-Abator for SSI, do not modify.
      This element was generated on Thu Sep 29 10:48:02 CST 2011.
    -->
    insert into medicine_jb (jb_id, cg_id, customer_account, medicine_code, ylcd, price, remark,
      jb_state, begin_date,end_date)
    values (#jbId#, #cgId#, #customerAccount#, #medicineCode#, #ylcd#, #price#, #remark#, #jbState#,
      #beginDate#,#endDate#)
  </insert>
  
    <!--第3次修改、曾经改动过、样品编号-->
  <insert id="insertPrepare" parameterClass="String" >
    insert into medicine_jb (cg_id, customer_account, medicine_code, ylcd, price, remark,
      jb_state, begin_date,end_date,hg_state,view)
    	select cg_id,#customerAccount#,null,null,null,null,'1',begin_date,end_date,'0',null
   		from medicine_cg where  cg_id not in
   			(select j.cg_id from  medicine_cg c,medicine_jb j where c.begin_date=j.begin_date and c.end_date=j.end_date and customer_account=#customerAccount#)
  </insert>
  <update id="updateByPrimaryKey" parameterClass="cn.krt.zbcg.commons.bo.system.MedicineJbBO" >
    update medicine_jb set hg_state = #hgState#,view = #view# where jb_id = #jbId#
  </update>
  
  
  <update id="updateJb" parameterClass="java.util.Map" >
    <!--
      WARNING - This element is automatically generated by GBOSS-Abator for SSI, do not modify.
      This element was generated on Thu Sep 29 10:48:02 CST 2011.
    -->
    update medicine_jb
    set 
      ylcd = #ylcd#,
      price = #price#,
      remark = #remark#
    where jb_id = #jbId#
  </update>
  
  <select id="tqjb" resultMap="CineJbResult" parameterClass="java.util.Map" >
    select 
    		*
    		
    from 
    		medicine_jb jb,medicine_cg cg
    where 
    	 jb.cg_id=cg.cg_id
		<isNotNull property="beginDate">
			<isNotEmpty  property="beginDate">
			and jb.begin_date = #beginDate#
			</isNotEmpty>
		</isNotNull>
  </select>
  
  <update id="updateJbJB" parameterClass="java.util.Map" >
    <!--
      WARNING - This element is automatically generated by GBOSS-Abator for SSI, do not modify.
      This element was generated on Thu Sep 29 10:48:02 CST 2011.
    -->
    update medicine_jb
    set 
       end_date = substring(current_date(),1,10)
    where jb_id = #jbId#
  </update>
  
  <select id="judeJB" resultMap="CineJbResult" parameterClass="cn.krt.zbcg.commons.bo.system.MedicineJbBO" >
    select jb_id, cg_id, customer_account, medicine_code, ylcd, price, remark, jb_state, begin_date,end_date,hg_state,view
    from medicine_jb
    where jb_id = #jbId# <![CDATA[ and substring(current_date(),1,10) > '$endDate$' ]]> 
  </select>
</sqlMap>