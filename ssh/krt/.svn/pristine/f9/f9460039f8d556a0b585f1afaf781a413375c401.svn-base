<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="medicine_zb" >
  <resultMap id="CineZbResult" class="cn.krt.zbcg.commons.bo.system.MedicineZbBO" >
    <!--
      WARNING - This element is automatically generated by GBOSS-Abator for SSI, do not modify.
      This element was generated on Thu Sep 29 10:48:02 CST 2011.
    -->
    <result column="zb_id" property="zbId" jdbcType="INTEGER" />
    <result column="jb_id" property="jbId" jdbcType="INTEGER" />
    <result column="hsl" property="hsl" jdbcType="INTEGER" />
    <result column="cfl" property="cfl" jdbcType="DOUBLE" />
    <result column="jcy" property="jcy" jdbcType="DOUBLE" />
    <result column="shr" property="shr" jdbcType="VARCHAR" />
    <result column="state" property="state" jdbcType="CHAR" />
    <result column="zb_state" property="zbState" jdbcType="CHAR" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="auth_state" property="authState" jdbcType="VARCHAR" />
    <result column="begin_date" property="beginDate" jdbcType="VARCHAR" />
    <result column="end_date" property="endDate" jdbcType="VARCHAR" />
    <result property="medicineJbBO" column="jb_id" select="medicine_jb.selectById"/>
  </resultMap>
  <select id="selectByPrimaryKey" resultMap="CineZbResult" parameterClass="cn.krt.zbcg.commons.bo.system.MedicineZbBO" >
    select zb_id, jb_id, hsl, cfl, jcy, shr, state, zb_state, remark, begin_date,end_date,auth_state
    from medicine_zb
    where zb_id = #zbId#
  </select>
  <select id="selectAll" resultMap="CineZbResult" parameterClass="java.util.Map" >
     SELECT * FROM ( SELECT  c.* from ( 
     select zb_id, zb.jb_id, hsl, cfl, jcy, shr, state, zb_state, zb.remark, zb.begin_date,zb.end_date,auth_state,medicine_code
    from medicine_zb zb,medicine_jb jb,medicine_cg cg
    where zb.jb_id=jb.jb_id  and jb.cg_id=cg.cg_id
		<isNotNull property="cgDate">
			<isNotEmpty  property="cgDate">
			and subString(zb.cg_date,1,7)=#cgDate#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="medicineCode">
			<isNotEmpty  property="medicineCode">
			and medicine_code=#medicineCode#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="medicineId">
				<isNotEmpty  property="medicineId">
				and cg.medicine_id = #medicineId#
				</isNotEmpty>
			</isNotNull>
		<isNotNull property="state">
			<isNotEmpty  property="state">
			and zb.state=#state#
			</isNotEmpty>
		</isNotNull>	
		<isNotNull property="beginDate">
			<isNotEmpty  property="beginDate">
		 <![CDATA[	and jb.begin_date >= '$beginDate$' ]]> 
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="endDate">
			<isNotEmpty  property="endDate">
			<![CDATA[ and jb.end_date <= '$endDate$' ]]> 
			</isNotEmpty>
		</isNotNull>
     ) c) a order by medicine_code asc 
     LIMIT  $ibegin$, 10
  </select>
  <select id="selectAllOfCount" resultClass="java.lang.String" parameterClass="java.util.Map" >
     SELECT count(1) as ID from ( 
      select zb_id, zb.jb_id, hsl, cfl, jcy, shr, state, zb_state, zb.remark, zb.begin_date,zb.end_date,auth_state
    from medicine_zb zb,medicine_jb jb,medicine_cg cg
    where zb.jb_id=jb.jb_id and jb.cg_id=cg.cg_id
		<isNotNull property="cgDate">
			<isNotEmpty  property="cgDate">
			and subString(zb.cg_date,1,7)=#cgDate#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="medicineCode">
			<isNotEmpty  property="medicineCode">
			and medicine_code=#medicineCode#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="medicineId">
				<isNotEmpty  property="medicineId">
				and cg.medicine_id = #medicineId#
				</isNotEmpty>
			</isNotNull>
		<isNotNull property="state">
			<isNotEmpty  property="state">
			and zb.state=#state#
			</isNotEmpty>
		</isNotNull>	
		<isNotNull property="beginDate">
			<isNotEmpty  property="beginDate">
		 <![CDATA[	and jb.begin_date >= '$beginDate$' ]]> 
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="endDate">
			<isNotEmpty  property="endDate">
			<![CDATA[ and jb.end_date <= '$endDate$' ]]> 
			</isNotEmpty>
		</isNotNull>
     ) c
  </select>
  <delete id="deleteByPrimaryKey" parameterClass="cn.krt.zbcg.commons.bo.system.MedicineZbBO" >
    delete from medicine_zb
    where zb_id = #zbId#
  </delete>
  <insert id="insert" parameterClass="cn.krt.zbcg.commons.bo.system.MedicineZbBO" >
    insert into medicine_zb (zb_id, jb_id, hsl, cfl, jcy, shr, state, zb_state, remark, begin_date,end_date)
    values (#zbId#, #jbId#, 0, #cfl#, #jcy#, #shr#, #state#, #zbState#, #remark#, #beginDate#,#endDate#)
  </insert>
  <update id="updateByPrimaryKey" parameterClass="cn.krt.zbcg.commons.bo.system.MedicineZbBO" >
    update medicine_zb
    set 
      cfl = #cfl#,
      jcy = #jcy#,
      shr = #shr#,
      state = #state#,
      remark = #remark#
    where zb_id = #zbId#
  </update>
  
  <insert id="insertPrepare" parameterClass="java.util.Map" >
    insert into medicine_zb (jb_id, hsl, cfl, jcy, shr, state, zb_state, remark, begin_date,end_date,auth_state)
    	select jb_id,null,null,null,null,'0',null,null,begin_date,end_date,'0'
   		from medicine_jb where jb_id not in
   			(select zb.jb_id from medicine_zb zb,medicine_jb jb where zb.begin_date=jb.begin_date and zb.end_date=jb.end_date) and jb_state='2'
  </insert>
  
   <select id="checkZbMedicine" resultMap="CineZbResult" parameterClass="java.util.Map" >
    select 
    		*
    		
    from 
    		medicine_zb zb,medicine_jb jb,medicine_cg cg
    where 
    		zb.jb_id=jb.jb_id and jb.cg_id=cg.cg_id and jb.jb_state= 2 and zb.state= 2 and zb.begin_date = #beginDate# and cg.medicine_id = #medicineId# 
    		
    		<![CDATA[ order by jb.price/((100-zb.hsl)*zb.cfl)*10000 asc ]]> 
  </select>
  
  <select id="resultForCg" resultMap="CineZbResult" parameterClass="java.util.Map" >
    select 
    		*
    		
    from 
    		medicine_zb zb,medicine_jb jb,medicine_cg cg
    where 
    		zb.jb_id=jb.jb_id and jb.cg_id=cg.cg_id and zb.zb_state= 1
    <isNotNull property="medicineId">
			<isNotEmpty  property="medicineId">
			and cg.medicine_id = #medicineId#
			</isNotEmpty>
		</isNotNull>
		<isNotNull property="beginDate">
			<isNotEmpty  property="beginDate">
			and zb.begin_date = #beginDate#
			</isNotEmpty>
		</isNotNull>
  </select>
  
  <select id="resultForSuppliers" resultMap="CineZbResult" parameterClass="java.util.Map" >
    select 
    		*
    		
    from 
    		medicine_zb zb,medicine_jb jb,medicine_cg cg
    where 
    		zb.jb_id=jb.jb_id and jb.cg_id=cg.cg_id and zb.zb_state= 1 and jb.customer_account = #customerAccount#
		<isNotNull property="beginDate">
			<isNotEmpty  property="beginDate">
			and zb.begin_date = #beginDate#
			</isNotEmpty>
		</isNotNull>
  </select>
  
   <update id="updateZbState" parameterClass="cn.krt.zbcg.commons.bo.system.MedicineZbBO" >
    update medicine_zb set zb_state = 1 where zb_id = #zbId#
  </update>
  <update id="updateZbStateFq" parameterClass="java.util.Map" >
    update 
    		medicine_zb A, 
    (select zb_id from medicine_zb zb,medicine_jb jb,medicine_cg cg where zb.jb_id=jb.jb_id and jb.cg_id=cg.cg_id and zb.zb_state= 1 and zb.begin_date = #beginDate# and cg.medicine_id = #medicineId#)B
    set 
    		zb_state = 0 
    where  A.zb_id = B.zb_id
    
  </update>
  <select id="tqjb" resultMap="CineZbResult" parameterClass="java.util.Map" >
    select 
    		*
    		
    from 
    		medicine_zb zb,medicine_jb jb,medicine_cg cg
    where 
    		zb.jb_id=jb.jb_id and jb.cg_id=cg.cg_id
		<isNotNull property="beginDate">
			<isNotEmpty  property="beginDate">
			and zb.beginDate = #beginDate#
			</isNotEmpty>
		</isNotNull>
  </select>
  <update id="updateZbAuthState" parameterClass="java.util.Map" >
    update 
    		medicine_zb A, 
    (select zb_id from medicine_zb zb,medicine_jb jb,medicine_cg cg where zb.jb_id=jb.jb_id and jb.cg_id=cg.cg_id and zb.begin_date = #beginDate# and cg.medicine_id = #medicineId#)B
    set 
    		auth_state = 1 
    where  A.zb_id = B.zb_id
    
  </update>
</sqlMap>